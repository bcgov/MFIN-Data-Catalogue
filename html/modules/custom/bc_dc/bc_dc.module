<?php

/**
 * @file
 * Module file.
 */

use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Render\Element;
use Drupal\node\NodeInterface;

/**
 * Implements hook_preprocess_HOOK().
 */
function bc_dc_preprocess_flag(array &$variables): void {
  // Replace @title with improved @aria-label.
  unset($variables['attributes']['title']);
  $title = $variables['flaggable']->getTitle();
  $variables['attributes']['aria-label'] = $variables['action'] === 'flag' ?
    t('Not bookmarked; add bookmark for "@title".', ['@title' => $title]) :
    t('Bookmarked; remove bookmark for "@title".', ['@title' => $title]);

  // Theme like a button.
  $variables['attributes']['class'][] = 'button';

  // Bookmark count message.
  // If at least one user has bookmarked an item, add a message with the count.
  $node_bookmark_count = bc_dc_count_node_bookmarks($variables['flaggable']);
  if ($node_bookmark_count > 0) {
    $args = [
      '@count' => $node_bookmark_count,
    ];
    $count_message = \Drupal::translation()->formatPlural($node_bookmark_count, 'Bookmarked by 1 person', 'Bookmarked by @count people', $args);
    $variables['title']['#markup'] = '<span class="title">' . $variables['title']['#markup'] . '</span> <span class="count">' . $count_message->render() . '</span>';
  }
}

/**
 * Return the number of bookmarks on a given entity.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The entity to count on.
 *
 * @return int
 *   The number of bookmarks on the given entity.
 */
function bc_dc_count_node_bookmarks(EntityInterface $entity): int {
  $count = \Drupal::service('flag.count')->getEntityFlagCounts($entity);
  return isset($count['bookmark']) ? ((int) $count['bookmark']) : 0;
}

/**
 * Implements hook_entity_display_build_alter().
 *
 * Based on hook implementation in empty_fields module.
 */
function bc_dc_entity_display_build_alter(array &$build, array $context): void {
  // Act only on build page view modes. Return early otherwise.
  $view_modes = [
    'data_set_build_page',
    'data_set_columns',
  ];
  if (!in_array($context['view_mode'], $view_modes, TRUE)) {
    return;
  }

  /** @var \Drupal\Core\Entity\EntityInterface $entity */
  $entity = $context['entity'];
  /** @var \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display */
  $display = $context['display'];
  foreach (Element::children($build) as $field_name) {
    if ($entity->get($field_name)->isEmpty()) {
      $definition = $entity->get($field_name)->getFieldDefinition();
      $component = $display->getComponent($field_name);

      $empty_text = $definition->isRequired() ? t('Required') : t('Optional');
      $markup = ['#markup' => '<em>' . $empty_text . '</em>'];

      $build[$field_name] = [
        '#theme' => 'field',
        '#title' => $definition->getLabel(),
        '#label_display' => $component['label'],
        '#view_mode' => $context['view_mode'],
        '#language' => $entity->get($field_name)->getLangcode(),
        '#field_name' => $definition->getName(),
        '#field_type' => 'string',
        '#field_translatable' => $definition->isTranslatable(),
        '#entity_type' => $entity->getEntityTypeId(),
        '#bundle' => $entity->bundle(),
        '#object' => $entity,
        '#items' => [(object) ['_attributes' => []]],
        '#is_multiple' => FALSE,
        // Use simple formatter.
        '#formatter' => 'string',
        '0' => $markup,
      ] + $build[$field_name];
    }
  }
}

/**
 * Implements hook_ENTITY_TYPE_view() for node.
 */
function bc_dc_node_view(array &$build, NodeInterface $entity, EntityViewDisplayInterface $display, string $view_mode): void {
  // Act only on data_set nodes.
  if ($entity->bundle() !== 'data_set') {
    return;
  }

  // Load the bookmark for this user for this node.
  $flag_service = \Drupal::service('flag');
  $bookmark_flag = $flag_service->getFlagById('bookmark');
  $bookmark_flagging = $flag_service->getFlagging($bookmark_flag, $entity);

  // Return if no bookmark on this node by the current user.
  if (!$bookmark_flagging) {
    return;
  }

  // Record that the node has been viewed. Update field_last_viewed_date to now.
  $bookmark_flagging->set('field_last_viewed_date', date('Y-m-d\TH:i:s'));
  $bookmark_flagging->save();
}
