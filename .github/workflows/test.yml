name: Deploy to Test

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@master

    - name: Export github reference var
      run: echo "GITHUB_REFERENCE=$(echo ${GITHUB_REF#refs/tags/})" >> $GITHUB_ENV

    - name: Checkout Tenant GitOps Repo
      uses: actions/checkout@v4
      with:
        repository: bcgov-c/tenant-gitops-ea352d
        path: tenant-gitops
        ssh-key: ${{ secrets.SSH_KEY }}
        persist-credentials: true

    - name: Update Argo CD
      uses: mikefarah/yq@v4.34.1
      with:
        cmd: |
          yq -i '.drupal.tag = strenv(GITHUB_REFERENCE) |
                 .nginx.tag = strenv(GITHUB_REFERENCE) ' tenant-gitops/helm-drupal/charts/drupal/values-mfin-data-catalogue-test.yaml

    - name: Commit files
      run: |
        cd tenant-gitops
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git commit -a -m "feat(helm): Update container images to ${{ env.GITHUB_REFERENCE }}"

    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        ssh: true
        branch: main
        directory: tenant-gitops
        repository: bcgov-c/tenant-gitops-ea352d
